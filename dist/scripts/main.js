!function(s,u){"use strict";var i=u.createElement("style"),l={};i.innerHTML="[clone] { display: none }",u.head.appendChild(i),Object.defineProperty(HTMLElement.prototype,"clone",{value:function(e,t){return e&&"object"!=typeof e||(t=e,e=this.getAttribute("insert")||"last"),l.main(this,e,t)}}),u.addEventListener("DOMContentLoaded",function(){for(var e=u.querySelectorAll("[clone]"),t=0,n=e.length;t<n;t++)l.init(e[t]);u.head.removeChild(i)}),l=s.Clone={init:function(e){for(var t=1<e.children.length?u.createElement("div"):u.createDocumentFragment(),n=0,i=e.childNodes.length;n<i;n++)t.appendChild(e.childNodes[n].cloneNode(!0));e.innerHTML="",e.classList.add("noClones"),Object.defineProperty(e,"cloneSource",{value:t,writeable:!0})},main:function(e,t,n){var i=e.getAttribute("clone"),r=i&&u.querySelector(i)||e;if(t=l.insert[t]||t,r&&t.call){Array.isArray(n)||(n=[n]);for(var o=[],a=0,s=n.length;a<s;a++)o.push(l.clone(e,r,t,n[a]));return e.classList.toggle("noClones",!n.length),l.index(e),1===o.length?o[0]:o}},clone:function(e,t,n,i){var r=(t.cloneSource||t).cloneNode(!0),o=r.classList?r:(r.children||r.childNodes)[0];if(o&&o.classList.add("cloned"),i&&l.values(o,i),n.call(e,r),s.CustomEvent){var a=new CustomEvent("cloned",{bubbles:!0});a.clone=r,a.source=t,a.insert=n,a.values=i,e.dispatchEvent(a)}return r},insert:{first:function(e){this.insertBefore(e,this.childNodes[0])},last:function(e){this.appendChild(e)}},values:function(e,t,n){if("function"==typeof t)t.call(e,e);else if("function"==typeof e.values)e.values(t);else if(e.children.length)for(var i=0,r=e.children.length;i<r;i++)l.values(e.children[i],t,!0);n||Object.defineProperty(e,"cloneValues",{value:t})},index:function(e){for(var t=e.querySelectorAll(".cloned"),n=0,i=t.length;n<i;n++)t[n].setAttribute("index",n)}}}(window,document),function(u){"use strict";var l={};Object.defineProperty(HTMLElement.prototype,"values",{value:function(e,t){switch(arguments.length){case 0:return this.querySelector(l.selector())?l.getAll(this):l.get(this);case 1:return l["object"==typeof e?"setAll":"getByName"](this,e);default:return l.setByName(this,e,t)}}}),l=u.Values={selector:function(e){return e&&'[name="'+e+'"],[index="'+e+'"]'||"[name],[index]"},attribute:function(e){return e.getAttribute("name")||e.getAttribute("index")},indexRE:/^[0-9]+$/,getAll:function(e,t){for(var n=0,i=e.children.length;n<i;n++){var r=e.children[n],o=l.attribute(r),a=!!r.querySelector(l.selector());o?(t||(t=l.indexRE.test(o)?[]:{}),t[o]=a?l.getAll(r):l.get(r,o)):a&&(t=l.getAll(r,t))}return t},getByName:function(e,t){t+="";for(var n=l.endpoints(e);n.length;){var i=n.shift();if(t===l.fullName(i,e)||t===l.attribute(i))return i.querySelector(l.selector())?l.getAll(i):l.get(i,t)}},get:function(e,t){var n=[e.getAttribute("read"),e.type,e.nodeName.toLowerCase()],i=l.conf.call(e,n,l.read).call(e,t);"string"==typeof i&&(n=[e.getAttribute("parse"),t,e.type],i=l.conf.call(e,n,l.parse).call(e,i,t));return i},parse:{default:function(t){try{return JSON.parse(t)}catch(e){return t}}},read:{checkbox:function(){for(var e=this.getAttribute("name"),t=this.parentNode.querySelectorAll(l.selector(e)),n=[],i=0,r=t.length;i<r;i++)t[i].checked&&n.push(t[i].value);return"radio"===this.type||1===t.length?n[0]:n},radio:"checkbox",input:function(){return this.value},textarea:"input",select:function(){for(var e=this.getAttribute("label"),t=this.querySelectorAll("option"),n=[],i=0,r=t.length;i<r;i++){var o=t[i];o.selected&&n.push(e&&"false"!==e?{value:o.value,label:o.label}:o.value)}return this.hasAttribute("multiple")?n:n[0]},default:function(e){return e&&this.getAttribute("data-"+e)||this.getAttribute(e)||this.innerText}},endpoints:function(e){for(var t=e.querySelectorAll(l.selector()),n=[],i=0,r=t.length;i<r;i++)t[i].querySelector(l.selector())||n.push(t[i]);return!n.length&&l.attribute(e)&&n.push(e),n},fullName:function(e,t){for(var n=[l.attribute(e)];e.parentNode&&e.parentNode!==t&&e.parentNode.getAttribute;)n.unshift(l.attribute(e=e.parentNode));for(var i="",r=!1;n.length;){var o=n.pop();o&&(r=l.indexRE.test(o)?(i+="["+o+"]",!1):(r&&(i+="."),i+=o,!0))}return i},setAll:function(n,i){var e=l.endpoints(n).map(function(e){var t=l.fullName(e,n);return[e,l.resolve(t,i),t]}).filter(function(e){return void 0!==e[1]});if(!e.length)for(var t,r=n.outerHTML,o=/{{(\w+(\.\w+|\[\d+])*)}}/g;t=o.exec(r);){var a=t[1],s=l.resolve(a,i);void 0!==s&&e.push([n,s,a])}return e.forEach(function(e){l.set.apply(l,e)}),n},setByName:function(e,t,n){for(var i=e.querySelectorAll(l.selector(t)),r="object"==typeof n?"setAll":"set",o=0,a=i.length;o<a;o++)l[r](i[o],n);return i},set:function(e,t,n){var i=[e.getAttribute("write"),e.type,e.nodeName.toLowerCase()],r=l.conf.call(e,i,l.write);(t&&t.value&&(t=t.value),"string"!=typeof t)&&(i=[e.getAttribute("stringify"),null!=t?t.constructor.name:"empty"],t=l.conf.call(e,i,l.stringify).call(e,t,n));r.call(e,t,n)},stringify:{Object:function(e){return JSON.stringify(e)},empty:function(){return""},Date:"Object",Array:"Object",default:function(e){return e+""}},write:{checkbox:function(e){var t=Array.isArray(e)?e:e.split(",");this.checked=0<=t.indexOf(this.value)},radio:"checkbox",input:function(e){this.value=e},textarea:"input",select:function(e){if(this.hasAttribute("multiple"))for(var t=Array.isArray(e)?e:e.split(","),n=this.querySelectorAll("option"),i=0,r=n.length;i<r;i++)0<=t.indexOf(n[i].value)&&(n[i].selected=!0);else this.value=e},default:function(e,t){var n=new RegExp("{{"+t+"}}","g");if(n.test(this.innerHTML))this.innerHTML=this.innerHTML.replace(n,e);else{for(var i=!1,r=0,o=this.attributes.length;r<o;r++){var a=this.attributes[r];n.test(a.value)&&(a.value=a.value.replace(n,e),i=!0)}i||(this.innerHTML=e)}}},conf:function(e,t){for(var n=[t,this,u],i=0,r=e.length;i<r;i++)for(var o=0,a=n.length;o<a;o++)if(e[i]){var s=l.resolve(e[i],n[o]);if("string"==typeof s&&(s=n[0][s]),"function"==typeof s)return s}return t.default},resolve:function(e,t){var n=(t=t||u)[e+=""];if(void 0===n&&e)for(var i=0;;){var r,o,a=e.indexOf(".",i);if(0<a)r=e.substring(0,a),o=e.substring(a+1),i=a+1;else{var s=e.indexOf("[",i);if(!(0<=s))break;r=e.substring(0,s),o=e.substring(s),i=s+1}if(r in t&&("["===o.charAt(0)&&(o=o.substring(1,o.indexOf("]"))),void 0!==(n=l.resolve(o,t[r]))))return n}return n}}}(window),function(s,a,o,r,u,t){"use strict";var e,n=(e=location.search.match(/apikey=(\w+)/))?e[1]:o("apikey"),i=function(e){return n?e+"?apikey="+n:e},l=0<location.toString().indexOf("staging"),c=window.app={api:new u({url:"/api"+(l?"-staging":""),debug:!0,throttle:{key:"staging",ms:510},requestData:function(e){c.loading(!0),c.saveCommunications("request",e,this)},load:function(){c.saveCommunications("response",this.response,this.cfg),c.loading(!1)},failure:function(e){c.error(e)},"@service":{url:"/",auto:!0,then:function(e){return s.query("[name=implementation_version]").innerHTML=e.implementation_version,e}},"@units":{url:"/units",saveResult:!0,responseData:function(e){return c.buildResource(e,"units")}},"@nutrients":{url:"/nutrients",saveResult:!0,responseData:function(e){return c.buildResource(e,"nutrients")}},"@search":{requires:["app.api.units"],url:"/foods?query={query}&count={count}&start={start}&spell={spell}"},"@view":{requires:["app.api.units","app.api.nutrients"],url:i("/food/{0}")},"@analyze":{requires:["app.api.nutrients","app.api.units"],method:"POST",headers:{"Content-Type":"application/vnd.com.esha.data.Foods+json"},url:i("/analysis")},"@recommend":{requires:["app.api.nutrients","app.api.units"],method:"POST",headers:{"Content-Type":"application/vnd.com.esha.data.PersonalProfile+json"},url:i("/recommendations")}}),saveCommunications:function(e,t,n){var i={direction:e,body:t,method:n.method||"GET",url:u.api.resolve(n.url,n.data,null,!1).replace(c.base,"")};if("response"===e){var r=n.xhr;i.headers=r.responseHeaders,i.status=r.status}else i.headers=n.headers;o(e,i),c.updateAPI()},_loading:0,loading:function(e){c._loading+=e?1:-1,t.toggle("loading",0<c._loading)},buildResource:function(e,t){var n={};return e.forEach(function(e){n[e.id]=e}),c[t]=n,o(t+".response",o("response")),o(t+".request",o("request")),n.__list__=e,n},service:function(){c.api.service().then(function(){a.fire.location("#response")})},search:function(e,t,n){var i=s.query("#options",1),r=i.classList.contains("hidden")?{}:i.values(),o=s.query("input[name=query]");n?(r.query=n,o.value=decodeURIComponent(n)):r.query=encodeURIComponent(o.value),r.query?(t="#query="+r.query,location.hash!==t&&a.fire.location(t),s.query("#results").values("query",r.query)):o.focus(),c.api.search(r).then(c.queryResults)},queryResults:function(e){c.results(e),c.controls(e)},controls:function(t){s.queryAll('[click="page"]').each(function(e){e.url=t[e.id+"_page"],e.classList.toggle("hidden",!e.url)})},page:function(e){c.api.extend({url:e.target.url})().then(c.queryResults)},options:function(){s.query("#options").classList.toggle("hidden")},results:function(e){var t=s.query("#results"),n=t.query("[clone]");n.innerHTML="",e.items.forEach(c.processUnits),n.clone(e.items);var i=t.query("#feedback"),r=s.documentElement.values("url"),o=r&&r.match(/start=(\d+)/);e.start=o&&parseInt(o[1])||0,e.end=e.start+e.items.length-1,i.classList.toggle("hidden",!e.items.length),i.values(e);var a=s.query("input[name=query]").value;t.classList.toggle("misspelled",e.query!==a)},items:o("list")||[],list:function(){var e=s.query("#list").query("[clone]");e.children.length!==c.items.length&&setTimeout(function(){e.innerHTML="",e.clone(c.items),e.queryAll(".food").each(function(e,t){var n=c.items[t],i=e.query("[name=unit]");r.init(i),i.clone(n.units),i.value=n.unit.id}),o("list",c.items)},100)},add:function(){c.items.push(this.cloneValues),a.fire.location("#list")},prepExternal:function(e){var t=s.query("#external"),n=t.query("select[name=unit]");e&&e.quantity||(e={quantity:1,calories:"",input:"",unit:"urn:uuid:85562e85-ba37-4e4a-8400-da43170204a7"}),c.api.units().then(function(){n.clone(c.units.__list__),t.values(e),n.value=e.unit})},externalBaseUri:"external_",external:function(){var e=s.query("#external"),t=c.units[e.query("[name=unit]").value],n={id:e.values("id"),description:e.values("description"),quantity:e.values("quantity"),unit:t,nutrient_data:[{nutrient:e.values("nutrient"),value:e.values("value")}],product:"-not in ESHA db-",units:[t]};c.items.push(n),a.fire.location("#list")},view:function(e,t,n){n?c.api.view(n).then(function(e){var t=s.query("#view"),n=t.query("[clone].values");c.processUnits(e),e.units=e.units.map(function(e){return e.description}).join(", "),c.ensureDefined(e,["group","supplier","product"]),t.values(e),n.innerHTML="",e.nutrient_data.forEach(c.processNutrientDatum),n.clone(e.nutrient_data)}).catch(c.error):(n=this.cloneValues.id).startsWith("urn:uuid:")?a.fire.location("#view/"+n):a.fire.location("#list")},ensureDefined:function(t,e){e.forEach(function(e){e in t||(t[e]=null)})},processUnits:function(e){e.unit=c.units[e.unitId||e.unit]||e.unit,e.units&&(e.units=e.units.map(function(e){return c.units[e]||e}))},processNutrientDatum:function(e){"number"==typeof e.value&&(e.value=Math.round(10*e.value)/10),e.nutrient=c.nutrients[e.nutrient]||e.nutrient},update:function(e){var t=this.getAttribute("index"),n=c.items[t],i=e.target.getAttribute("name"),r=e.target.value;n[i]="unit"===i?c.units[r]:r},remove:function(){var e=this.nearest("[index]").getAttribute("index");c.items.splice(e,1),c.list()},clear:function(){c.items=[],c.list()},analyze:function(){var n={items:[]};c.items.forEach(function(e){var t={id:e.id,quantity:e.quantity,unit:e.unit.id};e.nutrient_data&&(t.description=e.description,t.nutrient_data=e.nutrient_data),n.items.push(t)}),c.api.analyze(n).then(c.analysis)},analysis:function(e){e.items.forEach(function(e){e.unit=c.units[e.unit]||e.unit}),e.results.forEach(c.processNutrientDatum);var t=s.query("#analysis"),n=t.query("[clone].values"),i=t.query("[clone].items");n.innerHTML="",i.innerHTML="",n.clone(e.results),i.clone(e.items)},recommend:function(){var e=s.query("#profile"),t=e.xValue;t.sex?o("lastProfile",t):o.has("lastProfile")&&(t=o("lastProfile"),e.xValue=t),t.age&&(t["ageIn"+t.ageUnit]=t.age),t.height&&(t["heightIn"+t.heightUnit]=t.height),t.weight&&(t["weightIn"+t.weightUnit]=t.weight),delete t.age,delete t.ageUnit,delete t.height,delete t.heightUnit,delete t.weight,delete t.weightUnit,delete t.bodyMassIndex,t.pregnancyDurationInWeeks||delete t.pregnancyDurationInWeeks,t.lactationDurationInMonths||delete t.lactationDurationInMonths,t.physicalActivityLevelCategory||delete t.physicalActivityLevelCategory,c.api.recommend(t).then(c.recommendations)},recommendations:function(e){e.recommendations.forEach(function(e){c.processNutrientDatum(e),c.processUnits(e)});var t=s.query("#recs");t.xValue=e,s.query("[name=bodyMassIndex]").value=e.profile.bodyMassIndex,s.query("[name=physicalActivityLevelCategory]").value=e.profile.physicalActivityLevelCategory;var n=t.query("[clone]");n.innerHTML="",n.clone(e.recommendations);var i=s.query("#profile"),r=i.xValue;r.age||(r.age=e.profile.ageInMonths,r.ageUnit="Months"),r.weight||(r.weight=e.profile.weightInKilograms,r.weightUnit="Kilograms"),r.height||(r.height=e.profile.heightInMeters,r.heightUnit="Meters"),i.xValue=r},network:function(e,t){var n=o(e);n.body=JSON.stringify(n.body,null,2),n.body.length<3&&(n.body=""),n.headers=JSON.stringify(n.headers,null,1).replace(/",?/g,"").substring(2).replace("\n}","\n"),s.query('[name="network"]').values(n),c.updateAPI(n),"location"!==t.type&&a.fire.location("#"+e)},updateAPI:function(e){s.query(".api").values(e||o("request"))},error:function(e){var t=o("response"),n=t.body&&t.body.messages?t.body.messages[0]:{text:"location"===e.type?"":e};n.status=t.status,s.query("[name=error]").values(n),e&&"location"===e.type||a.fire.location("#error")},goto:function(e){var t=e.category,n='[name$="'+t+'Id"],[name$="'+t+'.id"]',i=e.target.parentElement.query(n);if(i){var r=i.textContent;a.fire.location("#"+t+"s"),setTimeout(function(){var e=s.body.query('[id="'+r+'"]');if(e){var t=e.parentElement;t.scrollIntoView(),t.classList.add("goto-target")}},500)}},resource:function(e,t,n){c.api[n]().then(function(e){var t=s.query('[vista="'+n+'"] [clone]');t.innerHTML="",t.clone(e.__list__),t.queryAll('[name="id"]').each(function(e){e.setAttribute("id",e.textContent)}),o("response",o(n+".response")),o("request",o(n+".request")),c.updateAPI()})}};a.alias("location"),a.on(window,{"location@#service":c.service,"location@`#(nutrients|units)`":c.resource,"location@#request":c.network.bind(c,"request"),"location@#response":c.network.bind(c,"response"),"location@#query={query}":c.search,"location@#list":c.list,"location@#analysis":c.analyze,"location@#recommendations":c.recommend,"location@#profile+recommendations":c.recommend,"location@#view/{uri}":c.view,"location@#external":c.prepExternal,"location@#error":c.error,search:c.search,recommend:c.recommend,"items:add<.food>":c.add,"items:external<.food>":c.external,"items:view<.food>":c.view,"items:remove<.food>":c.remove,"items:clear":c.clear,goto:c.goto,page:c.page,options:c.options,"change<.food>":c.update})}(document,window.Eventi,window.store,window.Clone,window.Posterior,window.Vista);